<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ù–∞–≤—á–∞–Ω–Ω—è + –ê–≤—Ç–æ–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ + –î–æ—à–∫–∞ —ñ–¥–µ–π</title>
  <style>
    :root{
      --bg:#0b0d10; --card:#11151b; --line:#243041;
      --text:#e9eef6; --muted:#a8b3c2;
      --accent:#6ee7ff; --ok:#9ff0a8; --bad:#ff9aa2; --warn:#ffd58a;
      --radius:16px; --shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 620px at 10% -10%, rgba(110,231,255,.14), transparent 55%),
        radial-gradient(900px 620px at 90% 0%, rgba(167,243,208,.12), transparent 55%),
        var(--bg);
      line-height:1.45;
    }
    .wrap{max-width:1150px;margin:0 auto;padding:20px}
    .top{
      padding:16px;border:1px solid var(--line);border-radius:var(--radius);
      background: rgba(255,255,255,.03);box-shadow: var(--shadow);
      display:flex; gap:12px; flex-wrap:wrap; justify-content:space-between; align-items:flex-start;
    }
    h1{margin:0 0 6px; font-size:18px}
    .sub{margin:0; color:var(--muted); font-size:13.5px; max-width:92ch}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03);
      color:var(--muted); border-radius:999px; padding:8px 10px; font-size:13px;
      cursor:pointer; user-select:none;
    }
    .tab.active{border-color:rgba(110,231,255,.55); color:var(--text)}
    .badge{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03);
      color:var(--muted); font-size:12.5px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.03);
      font-size:12.5px; color:var(--muted);
    }
    .card{
      border:1px solid rgba(255,255,255,.10); border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      padding:16px; margin-top:12px; box-shadow: 0 10px 22px rgba(0,0,0,.25);
    }
    h2{margin:0 0 10px; font-size:16px}
    h3{margin:0 0 10px; font-size:15px}
    .muted{color:var(--muted)}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media(max-width:980px){ .two{grid-template-columns:1fr} }
    label{display:block; margin:8px 0; font-size:14px}
    input[type="text"], textarea, select{
      width:100%;
      background: rgba(255,255,255,.02);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius:12px;
      padding:10px;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    .btn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius:12px;
      color:var(--text);
      text-decoration:none;
      font-weight:800;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:10px;
    }
    .btn.primary{
      border-color: rgba(110,231,255,.45);
      background: linear-gradient(135deg, rgba(110,231,255,.20), rgba(167,243,208,.10));
    }
    .btn.danger{border-color: rgba(255,154,162,.45)}
    .btn:disabled{opacity:.45; cursor:not-allowed}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .q{
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      background: rgba(255,255,255,.02);
      padding:12px;
      margin:10px 0;
    }
    .qt{font-weight:900;margin:0 0 8px}
    .opt{display:flex; gap:10px; align-items:flex-start; margin:8px 0}
    .opt input{margin-top:3px}
    .status.ok{color:var(--ok); font-weight:900}
    .status.bad{color:var(--bad); font-weight:900}
    .status.warn{color:var(--warn); font-weight:900}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .hidden{display:none !important}
    .progress{
      height:10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    .progress > div{height:100%; background: rgba(110,231,255,.35); width:0%}
    .kpiGrid{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    @media(max-width:980px){ .kpiGrid{grid-template-columns:1fr 1fr} }
    @media(max-width:520px){ .kpiGrid{grid-template-columns:1fr} }
    .kpi{
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      background: rgba(255,255,255,.02);
      padding:10px;
    }
    .kpi .t{margin:0; color:var(--muted); font-size:12px}
    .kpi .v{margin:6px 0 0; font-weight:1000}
    .list{margin:8px 0 0; padding-left:18px}
    .list li{margin:6px 0}

    /* Board */
    .boardTop{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    .filters{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .cols{display:grid; grid-template-columns:repeat(6,1fr); gap:10px; margin-top:10px}
    @media(max-width:1200px){ .cols{grid-template-columns:repeat(3,1fr)} }
    @media(max-width:760px){ .cols{grid-template-columns:1fr} }
    .col{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background: rgba(255,255,255,.02);
      padding:10px;
      min-height:220px;
    }
    .col h4{margin:0 0 8px; font-size:13px; color:var(--muted); display:flex; justify-content:space-between; gap:8px}
    .colCount{font-weight:900; color:var(--text)}
    .ideaCard{
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:10px;
      background: rgba(255,255,255,.02);
      margin:8px 0;
      cursor:pointer;
    }
    .ideaTitle{font-weight:900; margin:0 0 6px}
    .ideaMeta{color:var(--muted); font-size:12px; display:flex; flex-wrap:wrap; gap:8px}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    /* Modal */
    .modalBg{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modalBg.show{display:flex}
    .modal{
      width:min(920px, 100%);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background: rgba(15,19,24,.98);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modalHead{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
    .modalHead h3{margin:0}
    .modalClose{cursor:pointer; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); border-radius:12px; padding:8px 10px; color:var(--text); font-weight:900}
    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background: rgba(15,19,24,.96);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 12px;
      border-radius:14px;
      display:none;
      gap:10px;
      align-items:center;
      box-shadow: var(--shadow);
      max-width:min(860px, calc(100vw - 24px));
      z-index:10000;
    }
    .toast.show{display:flex}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 18px rgba(110,231,255,.45)}
    .hint{font-size:12.5px; color:var(--muted); margin:8px 0 0}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>–ù–∞–≤—á–∞–Ω–Ω—è + –ê–≤—Ç–æ–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ + –î–æ—à–∫–∞ —ñ–¥–µ–π</h1>
      <p class="sub">
        ‚Äú–í—ñ–¥–ø—Ä–∞–≤–∫–∞‚Äù –ø—Ä–∞—Ü—é—î –æ—Ñ–ª–∞–π–Ω: —ñ–¥–µ—ó –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ —Ü—å–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ —ñ –ø–µ—Ä–µ—Ö–æ–¥—è—Ç—å –ø–æ —Å—Ç–∞—Ç—É—Å–∞—Ö.
        –Ñ –µ–∫—Å–ø–æ—Ä—Ç —É JSON/CSV.
      </p>
      <div class="row" style="margin-top:10px">
        <span class="badge">‚úÖ –ù–∞–≤—á–∞–Ω–Ω—è: <b>8/10</b> + –ø—Ä–∞–∫—Ç–∏–∫–∞</span>
        <span class="badge">üß† –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: <b>Score 0‚Äì100</b></span>
        <span class="badge">üìå –†–æ–±–æ—Ç–∞: <b>–î–æ—à–∫–∞ —Å—Ç–∞—Ç—É—Å—ñ–≤</b></span>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-view="training">–ù–∞–≤—á–∞–Ω–Ω—è</div>
      <div class="tab" data-view="submit">–ü–æ–¥–∞—á–∞</div>
      <div class="tab" data-view="board">–î–æ—à–∫–∞ —ñ–¥–µ–π</div>
    </div>
  </div>

  <!-- TRAINING -->
  <div id="view_training">
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div>
          <h2 style="margin:0">–ù–∞–≤—á–∞–Ω–Ω—è</h2>
          <p class="muted" style="margin:6px 0 0">–ö—Ä–æ–∫–∏: –≤—Å—Ç—É–ø ‚Üí –ø—Ä–∞–≤–∏–ª–∞ ‚Üí —Ç–µ—Å—Ç ‚Üí –ø—Ä–∞–∫—Ç–∏–∫–∞ ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
        </div>
        <div class="pill">–ö—Ä–æ–∫ <b id="stepNum">1</b>/5</div>
      </div>

      <div class="hr"></div>
      <div class="progress"><div id="progBar"></div></div>
      <div class="hr"></div>

      <div class="step" data-step="1">
        <h3>1) –í—Å—Ç—É–ø</h3>
        <p class="muted" style="margin:0">
          –Ü–¥–µ—ó ‚Äî —Ü–µ –∫–∞–Ω–∞–ª –ø–æ–∫—Ä–∞—â–µ–Ω—å: <b>–ø—Ä–æ—Ü–µ—Å–∏</b>, <b>—Å–µ—Ä–≤—ñ—Å</b>, <b>–∫—É–ª—å—Ç—É—Ä–∞</b>, <b>–∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è</b>, <b>–Ω–∞–≤—á–∞–Ω–Ω—è</b>, <b>–∫–æ–º—Ñ–æ—Ä—Ç/–±–µ–∑–ø–µ–∫–∞</b>.
        </p>
        <div class="hr"></div>
        <p style="margin:0"><b>–§–æ—Ä–º—É–ª–∞:</b> –ü—Ä–æ–±–ª–µ–º–∞ ‚Üí –†—ñ—à–µ–Ω–Ω—è ‚Üí –ï—Ñ–µ–∫—Ç. <b>1 —Ñ–æ—Ä–º–∞ = 1 —ñ–¥–µ—è.</b></p>
      </div>

      <div class="step hidden" data-step="2">
        <h3>2) –ü—Ä–∞–≤–∏–ª–∞</h3>
        <div class="two">
          <div class="q">
            <p class="qt">–Ø–∫—ñ—Å–Ω–∞ —ñ–¥–µ—è</p>
            <ul class="muted list">
              <li>–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞ –¥—ñ—è (—â–æ –∑–º—ñ–Ω–∏—Ç–∏)</li>
              <li>–µ—Ñ–µ–∫—Ç (—â–æ —Å—Ç–∞–Ω–µ –∫—Ä–∞—â–µ)</li>
              <li>–ø—Ä–∏–∫–ª–∞–¥/–¥–æ–∫–∞–∑ (–∑–∞ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ)</li>
            </ul>
          </div>
          <div class="q">
            <p class="qt">–©–æ –≤–∞–∂–ª–∏–≤–æ</p>
            <ul class="muted list">
              <li>—Ñ—ñ–¥–±–µ–∫ –º–∞—î –±—É—Ç–∏ –∑–∞–≤–∂–¥–∏</li>
              <li>–±–µ–∫–ª–æ–≥ ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–æ</li>
              <li>–≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è = —Ç–µ—Å—Ç ‚Üí —Ä—ñ—à–µ–Ω–Ω—è ‚Üí –º–∞—Å—à—Ç–∞–±</li>
            </ul>
          </div>
        </div>
        <div class="hr"></div>
        <p class="muted" style="margin:0">
          –ê–≤—Ç–æ—Ä –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è –¥—ñ–∞–ª–æ–≥—É: —É—Ç–æ—á–Ω–µ–Ω–Ω—è, —Ñ—ñ–¥–±–µ–∫, –∑–∞–ª—É—á–µ–Ω–Ω—è –¥–æ —Ç–µ—Å—Ç—É —Ç–∞ –≤–∏–∑–Ω–∞–Ω–Ω—è –≤–Ω–µ—Å–∫—É.
        </p>
      </div>

      <div class="step hidden" data-step="3">
        <h3>3) –¢–µ—Å—Ç (10 –ø–∏—Ç–∞–Ω—å)</h3>
        <p class="muted" style="margin:0 0 10px">–ü—Ä–æ—Ö—ñ–¥: 8/10. –¢—Ä–µ–±–∞ –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ –Ω–∞ –≤—Å—ñ.</p>
        <div id="quizBox"></div>
      </div>

      <div class="step hidden" data-step="4">
        <h3>4) –ü—Ä–∞–∫—Ç–∏–∫–∞</h3>
        <div class="two">
          <div class="q">
            <p class="qt">–ü–µ—Ä–µ–ø–∏—à–∏ ‚Äú–ø–æ–≥–∞–Ω—É‚Äù —ñ–¥–µ—é</p>
            <p class="muted" style="margin:0 0 10px">–ü–æ–≥–∞–Ω–æ: ‚Äú–ó—Ä–æ–±—ñ—Ç—å —è–∫–æ—Å—å –∫—Ä–∞—â–µ, –±–æ –ø–æ—Å—Ç—ñ–π–Ω–æ –ø–ª—É—Ç–∞–Ω–∏–Ω–∞.‚Äù</p>
            <label>–ü–µ—Ä–µ–ø–∏—à–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ</label>
            <textarea id="rewrite1" placeholder="–ü—Ä–æ–±–ª–µ–º–∞: ...&#10;–†—ñ—à–µ–Ω–Ω—è: ...&#10;–ï—Ñ–µ–∫—Ç: ..."></textarea>
          </div>
          <div class="q">
            <p class="qt">–ó–±–µ—Ä–∏ —ñ–¥–µ—é –ø–æ —à–∞–±–ª–æ–Ω—É</p>
            <label>–ü—Ä–æ–±–ª–µ–º–∞</label>
            <textarea id="tpl_problem" placeholder="–î–µ –≤–∏–Ω–∏–∫–∞—î —ñ —â–æ —Å–∞–º–µ –Ω–µ —Ç–∞–∫"></textarea>
            <label>–†—ñ—à–µ–Ω–Ω—è</label>
            <textarea id="tpl_solution" placeholder="–©–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∑–º—ñ–Ω–∏—Ç–∏ / –∑—Ä–æ–±–∏—Ç–∏"></textarea>
            <label>–ï—Ñ–µ–∫—Ç</label>
            <textarea id="tpl_effect" placeholder="–ú–µ–Ω—à–µ –ø–æ–º–∏–ª–æ–∫ / —à–≤–∏–¥—à–µ / –∫–æ–º—Ñ–æ—Ä—Ç / —Å–µ—Ä–≤—ñ—Å"></textarea>
            <label>–î–æ–∫–∞–∑–∏ / –ø—Ä–∏–∫–ª–∞–¥–∏</label>
            <textarea id="tpl_proof" placeholder="–ü—Ä–∏–∫–ª–∞–¥, —Ñ–æ—Ç–æ/—Å–∫—Ä—ñ–Ω (–æ–ø–∏—Å)"></textarea>
            <div class="two" style="margin-top:10px">
              <div>
                <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                <select id="cat">
                  <option value="">‚Äî –æ–±–µ—Ä–∏ ‚Äî</option>
                  <option value="–ü—Ä–æ—Ü–µ—Å–∏">–ü—Ä–æ—Ü–µ—Å–∏</option>
                  <option value="–ö—É–ª—å—Ç—É—Ä–∞">–ö—É–ª—å—Ç—É—Ä–∞</option>
                  <option value="–ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è">–ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è</option>
                  <option value="–°–µ—Ä–≤—ñ—Å">–°–µ—Ä–≤—ñ—Å</option>
                  <option value="–ù–∞–≤—á–∞–Ω–Ω—è">–ù–∞–≤—á–∞–Ω–Ω—è</option>
                  <option value="–£–º–æ–≤–∏/–±–µ–∑–ø–µ–∫–∞/–∫–æ–º—Ñ–æ—Ä—Ç">–£–º–æ–≤–∏/–±–µ–∑–ø–µ–∫–∞/–∫–æ–º—Ñ–æ—Ä—Ç</option>
                  <option value="–Ü–Ω—à–µ">–Ü–Ω—à–µ</option>
                </select>
              </div>
              <div>
                <label>–ì–æ—Ç–æ–≤–∏–π(–∞) –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∑ —Ç–µ—Å—Ç–æ–º?</label>
                <select id="help">
                  <option value="–¢–∞–∫">–¢–∞–∫</option>
                  <option value="–ù—ñ">–ù—ñ</option>
                </select>
              </div>
            </div>
            <label style="margin-top:10px">–ß–æ–º—É —Ü—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—è?</label>
            <textarea id="catWhy" placeholder="1‚Äì2 —Ä–µ—á–µ–Ω–Ω—è"></textarea>
          </div>
        </div>
      </div>

      <div class="step hidden" data-step="5">
        <h3>5) –†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
        <div class="row">
          <button class="btn primary" id="calcBtn" type="button">–ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
          <button class="btn" id="copyCodeBtn" type="button" disabled>–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –∫–æ–¥</button>
          <button class="btn" id="gotoSubmitBtn" type="button" disabled>–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–æ–¥–∞—á—ñ</button>
          <button class="btn danger" id="resetTrainingBtn" type="button">–°–∫–∏–Ω—É—Ç–∏</button>
        </div>

        <div class="hr"></div>
        <div class="row" style="margin-bottom:10px">
          <span class="badge">–¢–µ—Å—Ç: <b id="quizScore">‚Äî</b></span>
          <span class="badge">–ü—Ä–∞–∫—Ç–∏–∫–∞: <b id="practiceScore">‚Äî</b></span>
          <span class="badge">–°—Ç–∞—Ç—É—Å: <b id="finalStatus" class="status">‚Äî</b></span>
        </div>

        <label>–ö–æ–¥ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è</label>
        <input id="passCode" class="mono" type="text" readonly placeholder="‚Äî" />
        <p class="muted" id="finalNote" style="margin:10px 0 0">–ù–∞—Ç–∏—Å–Ω–∏ ‚Äú–ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏‚Äù.</p>
      </div>

      <div class="hr"></div>
      <div class="row" style="justify-content:space-between">
        <button class="btn" id="prevBtn" type="button">–ù–∞–∑–∞–¥</button>
        <button class="btn primary" id="nextBtn" type="button">–î–∞–ª—ñ</button>
      </div>
    </div>
  </div>

  <!-- SUBMIT -->
  <div id="view_submit" class="hidden">
    <div class="card">
      <h2>–ü–æ–¥–∞—á–∞ —ñ–¥–µ—ó + –ê–≤—Ç–æ–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞</h2>
      <p class="muted" style="margin:0 0 10px">
        –°–ø–æ—á–∞—Ç–∫—É –≤–≤–µ–¥–∏ –∫–æ–¥ —ñ –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äú–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–æ–¥‚Äù. –ü–æ—Ç—ñ–º ‚Äú–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —ñ–¥–µ—é‚Äù ‚Üí ‚Äú–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏‚Äù.
      </p>

      <div class="q" style="margin-top:0">
        <p class="qt">–ö–æ–¥ –¥–æ—Å—Ç—É–ø—É</p>
        <div class="two">
          <div>
            <label>–ö–æ–¥</label>
            <input id="submitCode" class="mono" type="text" placeholder="IDEA-OK-2025-XXXX" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn primary" id="checkCodeBtn" type="button">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–æ–¥</button>
          </div>
        </div>
        <p class="muted" id="codeCheckNote" style="margin:10px 0 0; font-size:12.5px"></p>
      </div>

      <div class="q">
        <p class="qt">–§–æ—Ä–º–∞ —ñ–¥–µ—ó</p>

        <label>–ê–≤—Ç–æ—Ä (–ü–Ü–ë –∞–±–æ –Ω—ñ–∫)</label>
        <input id="i_author" type="text" placeholder="–•—Ç–æ –ø–æ–¥–∞–≤ —ñ–¥–µ—é" />

        <label>–ù–∞–∑–≤–∞</label>
        <input id="i_title" type="text" placeholder="–ö–æ—Ä–æ—Ç–∫–æ —ñ –ø–æ —Å—É—Ç—ñ (—â–æ –∑–º—ñ–Ω—é—î–º–æ)" />

        <label>–ü—Ä–æ–±–ª–µ–º–∞</label>
        <textarea id="i_problem" placeholder="–î–µ –≤–∏–Ω–∏–∫–∞—î —ñ —â–æ —Å–∞–º–µ –Ω–µ —Ç–∞–∫ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ)"></textarea>

        <label>–†—ñ—à–µ–Ω–Ω—è</label>
        <textarea id="i_solution" placeholder="–©–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∑—Ä–æ–±–∏—Ç–∏: –∑–º—ñ–Ω–∏—Ç–∏/–¥–æ–¥–∞—Ç–∏/–ø—Ä–∏–±—Ä–∞—Ç–∏/–Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏..."></textarea>

        <label>–ï—Ñ–µ–∫—Ç</label>
        <textarea id="i_effect" placeholder="–©–æ –ø–æ–∫—Ä–∞—â–∏—Ç—å—Å—è: —á–∞—Å/–ø–æ–º–∏–ª–∫–∏/–≥—Ä–æ—à—ñ/—Å–µ—Ä–≤—ñ—Å/–∫–æ–º—Ñ–æ—Ä—Ç. –ë–∞–∂–∞–Ω–æ —Ü–∏—Ñ—Ä—É/–ø–µ—Ä—ñ–æ–¥."></textarea>

        <label>–î–æ–∫–∞–∑–∏ / –ø—Ä–∏–∫–ª–∞–¥ (–±–∞–∂–∞–Ω–æ)</label>
        <textarea id="i_proof" placeholder="–ü—Ä–∏–∫–ª–∞–¥ —Å–∏—Ç—É–∞—Ü—ñ—ó, —Å–∫—Ä—ñ–Ω/—Ñ–æ—Ç–æ (–æ–ø–∏—Å)"></textarea>

        <div class="two">
          <div>
            <label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
            <select id="i_cat">
              <option value="–ü—Ä–æ—Ü–µ—Å–∏">–ü—Ä–æ—Ü–µ—Å–∏</option>
              <option value="–ö—É–ª—å—Ç—É—Ä–∞">–ö—É–ª—å—Ç—É—Ä–∞</option>
              <option value="–ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è">–ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è</option>
              <option value="–°–µ—Ä–≤—ñ—Å">–°–µ—Ä–≤—ñ—Å</option>
              <option value="–ù–∞–≤—á–∞–Ω–Ω—è">–ù–∞–≤—á–∞–Ω–Ω—è</option>
              <option value="–£–º–æ–≤–∏/–±–µ–∑–ø–µ–∫–∞/–∫–æ–º—Ñ–æ—Ä—Ç">–£–º–æ–≤–∏/–±–µ–∑–ø–µ–∫–∞/–∫–æ–º—Ñ–æ—Ä—Ç</option>
              <option value="–Ü–Ω—à–µ">–Ü–Ω—à–µ</option>
            </select>
          </div>
          <div>
            <label>–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª</label>
            <input id="i_dept" type="text" placeholder="–°–∞–ª–æ–Ω/–°–∫–ª–∞–¥/–û—Ñ—ñ—Å/..." />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="validateBtn" type="button" disabled>–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —ñ–¥–µ—é</button>
          <button class="btn" id="sendIdeaBtn" type="button" disabled>–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —ñ–¥–µ—é</button>
          <button class="btn" id="copyIdeaBtn" type="button" disabled>–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
          <button class="btn" id="clearIdeaBtn" type="button">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>

        <p class="hint">‚Äú–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏‚Äù –¥–æ–¥–∞—î —ñ–¥–µ—é –≤ ‚Äú–î–æ—à–∫—É —ñ–¥–µ–π‚Äù.</p>
      </div>

      <div class="q">
        <p class="qt">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏</p>

        <div class="kpiGrid">
          <div class="kpi"><p class="t">Score</p><p class="v" id="v_score">‚Äî</p></div>
          <div class="kpi"><p class="t">–°—Ç–∞—Ç—É—Å</p><p class="v" id="v_status">‚Äî</p></div>
          <div class="kpi"><p class="t">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è (AI-lite)</p><p class="v" id="v_guess">‚Äî</p></div>
          <div class="kpi"><p class="t">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è</p><p class="v" id="v_reco">‚Äî</p></div>
        </div>

        <div class="hr"></div>
        <div class="two">
          <div>
            <p class="qt" style="margin:0 0 8px">‚úÖ –©–æ –¥–æ–±—Ä–µ</p>
            <ul class="list" id="v_good"></ul>
          </div>
          <div>
            <p class="qt" style="margin:0 0 8px">‚ö†Ô∏è –©–æ –¥–æ–ø—Ä–∞—Ü—é–≤–∞—Ç–∏</p>
            <ul class="list" id="v_fix"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOARD -->
  <div id="view_board" class="hidden">
    <div class="card">
      <div class="boardTop">
        <div>
          <h2 style="margin:0">–î–æ—à–∫–∞ —ñ–¥–µ–π</h2>
          <p class="muted" style="margin:6px 0 0">–ö–ª—ñ–∫–Ω–∏ –ø–æ –∫–∞—Ä—Ç—Ü—ñ ‚Äî –≤—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è –¥–µ—Ç–∞–ª—ñ, —Å—Ç–∞—Ç—É—Å —ñ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ.</p>
        </div>
        <div class="filters">
          <input id="searchBox" type="text" placeholder="–ü–æ—à—É–∫ (–Ω–∞–∑–≤–∞/–∞–≤—Ç–æ—Ä/–ø—ñ–¥—Ä–æ–∑–¥—ñ–ª)..." style="min-width:280px" />
          <select id="filterCat">
            <option value="">–£—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
            <option>–ü—Ä–æ—Ü–µ—Å–∏</option><option>–ö—É–ª—å—Ç—É—Ä–∞</option><option>–ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è</option><option>–°–µ—Ä–≤—ñ—Å</option><option>–ù–∞–≤—á–∞–Ω–Ω—è</option><option>–£–º–æ–≤–∏/–±–µ–∑–ø–µ–∫–∞/–∫–æ–º—Ñ–æ—Ä—Ç</option><option>–Ü–Ω—à–µ</option>
          </select>
          <button class="btn" id="exportJsonBtn" type="button">–ï–∫—Å–ø–æ—Ä—Ç JSON</button>
          <button class="btn" id="exportCsvBtn" type="button">–ï–∫—Å–ø–æ—Ä—Ç CSV</button>
          <button class="btn danger" id="clearAllBtn" type="button">–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
        </div>
      </div>

      <div class="cols" id="boardCols"></div>
      <p class="hint" style="margin-top:10px">–î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É —Ç–≤–æ—î–º—É –±—Ä–∞—É–∑–µ—Ä—ñ (localStorage). –î–ª—è –∫–æ–º–∞–Ω–¥–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ –ø–æ—Ç—Ä—ñ–±–µ–Ω —Å–µ—Ä–≤–µ—Ä/—Ç–∞–±–ª–∏—Ü—è ‚Äî –∑—Ä–æ–±–∏–º–æ –ø–æ—Ç—ñ–º.</p>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modalBg" id="modalBg" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="–î–µ—Ç–∞–ª—ñ —ñ–¥–µ—ó">
      <div class="modalHead">
        <div>
          <h3 id="m_title">‚Äî</h3>
          <div class="ideaMeta" id="m_meta"></div>
        </div>
        <button class="modalClose" id="modalCloseBtn" type="button">–ó–∞–∫—Ä–∏—Ç–∏</button>
      </div>

      <div class="hr"></div>

      <div class="two">
        <div class="q" style="margin:0">
          <p class="qt">–û–ø–∏—Å</p>
          <div class="muted" style="font-size:12.5px">–ü—Ä–æ–±–ª–µ–º–∞</div>
          <div id="m_problem" style="white-space:pre-wrap"></div>
          <div class="hr"></div>
          <div class="muted" style="font-size:12.5px">–†—ñ—à–µ–Ω–Ω—è</div>
          <div id="m_solution" style="white-space:pre-wrap"></div>
          <div class="hr"></div>
          <div class="muted" style="font-size:12.5px">–ï—Ñ–µ–∫—Ç</div>
          <div id="m_effect" style="white-space:pre-wrap"></div>
          <div class="hr"></div>
          <div class="muted" style="font-size:12.5px">–î–æ–∫–∞–∑–∏/–ø—Ä–∏–∫–ª–∞–¥</div>
          <div id="m_proof" style="white-space:pre-wrap"></div>
        </div>

        <div class="q" style="margin:0">
          <p class="qt">–†–æ–±–æ—Ç–∞ –∑ —ñ–¥–µ—î—é</p>

          <label>–°—Ç–∞—Ç—É—Å</label>
          <select id="m_status">
            <option value="new">–ù–æ–≤—ñ</option>
            <option value="review">–ù–∞ —Ä–æ–∑–≥–ª—è–¥—ñ</option>
            <option value="backlog">Backlog</option>
            <option value="test">–¢–µ—Å—Ç</option>
            <option value="done">–í–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–æ</option>
            <option value="rejected">–í—ñ–¥—Ö–∏–ª–µ–Ω–æ</option>
          </select>

          <label style="margin-top:10px">–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π / —Ä—ñ—à–µ–Ω–Ω—è</label>
          <input id="m_owner" type="text" placeholder="–•—Ç–æ –≤–µ–¥–µ / —â–æ –≤–∏—Ä—ñ—à–∏–ª–∏" />

          <label style="margin-top:10px">–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
          <textarea id="m_comment" placeholder="–ö–æ—Ä–æ—Ç–∫–æ: —â–æ –∑—Ä–æ–±–ª–µ–Ω–æ / —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ —É—Ç–æ—á–Ω–∏—Ç–∏"></textarea>

          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="m_saveBtn" type="button">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <button class="btn danger" id="m_deleteBtn" type="button">–í–∏–¥–∞–ª–∏—Ç–∏</button>
          </div>

          <div class="hr"></div>
          <p class="muted" style="margin:0; font-size:12.5px">–Ü—Å—Ç–æ—Ä—ñ—è</p>
          <div id="m_history" class="muted" style="margin-top:8px; font-size:12.5px; white-space:pre-wrap"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <div class="dot" aria-hidden="true"></div>
    <div id="toastText">–ì–æ—Ç–æ–≤–æ</div>
  </div>
</div>

<script>
window.addEventListener("DOMContentLoaded", () => {
  // ---------- Helpers ----------
  const $ = (id)=>document.getElementById(id);
  const toast = $("toast"), toastText = $("toastText");
  const nowIso = ()=> new Date().toISOString();
  const fmtDate = (iso)=>{
    try{
      const d = new Date(iso);
      return d.toLocaleString("uk-UA");
    }catch{ return iso; }
  };

  function showToast(t){
    toastText.textContent = t;
    toast.classList.add("show");
    clearTimeout(window.__tt);
    window.__tt = setTimeout(()=>toast.classList.remove("show"), 2200);
  }
  function normalize(s){ return (s||"").toLowerCase().replace(/\s+/g," ").trim(); }
  function setList(ul, items){
    ul.innerHTML = "";
    (items||[]).forEach(t=>{
      const li=document.createElement("li");
      li.textContent = t;
      ul.appendChild(li);
    });
    if(!(items||[]).length){
      const li=document.createElement("li");
      li.textContent = "‚Äî";
      ul.appendChild(li);
    }
  }
  async function copyText(txt){
    try{ await navigator.clipboard.writeText(txt); }
    catch{
      const ta=document.createElement("textarea"); ta.value=txt;
      document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove();
    }
    showToast("–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ");
  }
  function genPassCode(){
    const y=new Date().getFullYear();
    const r=Math.floor(1000+Math.random()*9000);
    return `IDEA-OK-${y}-${r}`;
  }

  // ---------- Tabs ----------
  const views = { training: $("view_training"), submit: $("view_submit"), board: $("view_board") };
  document.querySelectorAll(".tab").forEach(tab=>{
    tab.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      tab.classList.add("active");
      const v=tab.dataset.view;
      Object.keys(views).forEach(k=>views[k].classList.toggle("hidden", k!==v));
      if(v==="board") renderBoard();
    });
  });

  // ---------- Training Wizard ----------
  let step = 1;
  function setStep(n){
    step = Math.max(1, Math.min(5, n));
    document.querySelectorAll(".step").forEach(s=>{
      s.classList.toggle("hidden", Number(s.dataset.step)!==step);
    });
    $("stepNum").textContent = String(step);
    $("progBar").style.width = `${(step-1)/4*100}%`;
    $("prevBtn").disabled = (step===1);
    $("nextBtn").textContent = (step===5) ? "–ì–æ—Ç–æ–≤–æ" : "–î–∞–ª—ñ";
  }
  $("prevBtn").addEventListener("click", ()=>setStep(step-1));
  $("nextBtn").addEventListener("click", ()=>{
    if(step===5){ showToast("–ù–∞—Ç–∏—Å–Ω–∏ ‚Äú–ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏‚Äù"); return; }
    setStep(step+1);
  });
  setStep(1);

  // ---------- Quiz ----------
  const PASS_SCORE = 8;
  const quizQuestions = [
    {id:"q1", text:"–û–¥–Ω–∞ —Ñ–æ—Ä–º–∞ = ‚Ä¶", options:["–û–¥–Ω–∞ —ñ–¥–µ—è","–ö—ñ–ª—å–∫–∞ —ñ–¥–µ–π –æ–¥—Ä–∞–∑—É","–ë—É–¥—å-—è–∫—ñ –¥—É–º–∫–∏"], correct:0},
    {id:"q2", text:"–ù–∞–π–∫—Ä–∞—â–∏–π —Ñ–æ—Ä–º–∞—Ç —ñ–¥–µ—ó:", options:["–ü—Ä–æ–±–ª–µ–º–∞ ‚Üí –†—ñ—à–µ–Ω–Ω—è ‚Üí –ï—Ñ–µ–∫—Ç","–•–æ—á—É ‚Üí –∑—Ä–æ–±—ñ—Ç—å","–°–∫–∞—Ä–≥–∞"], correct:0},
    {id:"q3", text:"–Ü–¥–µ—è –º–æ–∂–µ –±—É—Ç–∏ –ø—Ä–æ –∫—É–ª—å—Ç—É—Ä—É/–∞—Ç–º–æ—Å—Ñ–µ—Ä—É?", options:["–¢–∞–∫","–ù—ñ"], correct:0},
    {id:"q4", text:"–ï—Ñ–µ–∫—Ç –ø–æ—Ç—Ä—ñ–±–µ–Ω —â–æ–±‚Ä¶", options:["–æ—Ü—ñ–Ω–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—å","–±—É–ª–æ –¥–æ–≤—à–µ","–Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ"], correct:0},
    {id:"q5", text:"–î–æ–∫–∞–∑–∏/–ø—Ä–∏–∫–ª–∞–¥–∏ –∫–æ—Ä–∏—Å–Ω—ñ –∫–æ–ª–∏‚Ä¶", options:["–ø–æ—è—Å–Ω—é—é—Ç—å –ø—Ä–æ–±–ª–µ–º—É","–Ω—ñ–∫–æ–ª–∏","—Ç—ñ–ª—å–∫–∏ –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö"], correct:0},
    {id:"q6", text:"–ê–≤—Ç–æ—Ä –≤–∫–∞–∑—É—î—Ç—å—Å—è —â–æ–±‚Ä¶", options:["—É—Ç–æ—á–Ω—é–≤–∞—Ç–∏ —Ç–∞ –¥–∞–≤–∞—Ç–∏ —Ñ—ñ–¥–±–µ–∫","–∫–∞—Ä–∞—Ç–∏","–±–∞–π–¥—É–∂–µ"], correct:0},
    {id:"q7", text:"3 —ñ–¥–µ—ó –≤ –æ–¥–Ω–æ–º—É –æ–ø–∏—Å—ñ —á–∏ –æ–∫—Ä–µ–º–æ?", options:["–û–∫—Ä–µ–º–æ","–í –æ–¥–Ω–æ–º—É"], correct:0},
    {id:"q8", text:"–Ø–∫—â–æ –Ω–µ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –∑–∞—Ä–∞–∑:", options:["—Ñ—ñ–¥–±–µ–∫ + –±–µ–∫–ª–æ–≥ (–∑–∞ –ø–æ—Ç—Ä–µ–±–∏)","—ñ–≥–Ω–æ—Ä","–≤–∏–¥–∞–ª–∏—Ç–∏"], correct:0},
    {id:"q9", text:"–Ü–¥–µ—ó –º–æ–∂—É—Ç—å –ø–æ–¥–∞–≤–∞—Ç–∏‚Ä¶", options:["–≤—Å—ñ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∏","—Ç—ñ–ª—å–∫–∏ –∫–µ—Ä—ñ–≤–Ω–∏–∫–∏"], correct:0},
    {id:"q10", text:"–Ü–¥–µ—ó ‚Äî —Ü–µ –ø—Ä–æ:", options:["–ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è","–ø–æ—à—É–∫ –≤–∏–Ω–Ω–∏—Ö"], correct:0},
  ];
  function renderQuiz(){
    const box = $("quizBox");
    box.innerHTML = "";
    quizQuestions.forEach((q, idx)=>{
      const el=document.createElement("div");
      el.className="q";
      el.innerHTML = `
        <p class="qt">${idx+1}. ${q.text}</p>
        ${q.options.map((opt,i)=>`
          <label class="opt">
            <input type="radio" name="${q.id}" value="${i}">
            <span>${opt}</span>
          </label>
        `).join("")}
      `;
      box.appendChild(el);
    });
  }
  renderQuiz();
  function getRadioValue(name){
    const el=document.querySelector(`input[name="${name}"]:checked`);
    return el ? Number(el.value) : null;
  }
  function scoreTextTraining(txt){
    const t=normalize(txt);
    if(!t) return 0;
    const hasAction=/(–ø–µ—Ä–µ–π–º–µ–Ω|–¥–æ–¥–∞—Ç|–∑–º—ñ–Ω|–ø—Ä–∏–±—Ä–∞—Ç|–Ω–∞–ª–∞—à—Ç|–≤–≤–µ—Å—Ç–∏|–æ–Ω–æ–≤–∏—Ç|–≤–ø—Ä–æ–≤–∞–¥|–æ–ø—Ç–∏–º—ñ–∑|–∞–≤—Ç–æ–º–∞—Ç–∏–∑|–≤—Å—Ç–∞–Ω–æ–≤|–ø–µ—Ä–µ—Ä–æ–±)/.test(t);
    const hasEffect=/(–º–µ–Ω—à–µ|–±—ñ–ª—å—à–µ|—à–≤–∏–¥—à–µ|–∑–º–µ–Ω—à|–ø–æ–∫—Ä–∞—â|—Å–∫–æ—Ä–æ—á|–ø—ñ–¥–≤–∏—â|–∑–Ω–∏–∑|–∫–æ–º—Ñ–æ—Ä—Ç|–∞—Ç–º–æ—Å—Ñ–µ—Ä|–∫—É–ª—å—Ç—É—Ä|–∫–æ–º—É–Ω—ñ–∫–∞—Ü|—Å–µ—Ä–≤—ñ—Å|–≤–∏—Ç—Ä–∞—Ç|–ø–æ–º–∏–ª)/.test(t);
    const hasStruct=/(–ø—Ä–æ–±–ª–µ–º–∞:|—Ä—ñ—à–µ–Ω–Ω—è:|–µ—Ñ–µ–∫—Ç:|–ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è:)/.test(t);
    return (hasAction?1:0)+(hasEffect?1:0)+(hasStruct?1:0);
  }

  // ---------- Auth / Pass Code ----------
  const LS = {
    passCode: "ideas_pass_code",
    passedAt: "ideas_passed_at",
    ideas: "ideas_board_items_v1"
  };
  let savedCode = localStorage.getItem(LS.passCode);

  function isCodeValid(code){
    const t=(code||"").trim();
    const formatOk = /^IDEA-OK-\d{4}-\d{4}$/.test(t);
    if(!formatOk) return false;
    if(savedCode && t !== savedCode) return false;
    return true;
  }

  function calcTraining(){
    let quizScore=0, answered=0;
    quizQuestions.forEach(q=>{
      const v=getRadioValue(q.id);
      if(v!==null){ answered++; if(v===q.correct) quizScore++; }
    });
    const quizOk = (answered===quizQuestions.length) && (quizScore>=PASS_SCORE);

    const r1 = scoreTextTraining($("rewrite1").value);
    const p = scoreTextTraining("–ü—Ä–æ–±–ª–µ–º–∞: "+$("tpl_problem").value);
    const s = scoreTextTraining("–†—ñ—à–µ–Ω–Ω—è: "+$("tpl_solution").value);
    const e = scoreTextTraining("–ï—Ñ–µ–∫—Ç: "+$("tpl_effect").value);

    const proofLen = normalize($("tpl_proof").value).length;
    const cat = $("cat").value;
    const catWhyLen = normalize($("catWhy").value).length;

    const practicePoints =
      (r1>=2 ? 1 : 0) +
      ((p+s+e)>=5 ? 1 : 0) +
      (proofLen>=12 ? 1 : 0) +
      (cat && catWhyLen>=8 ? 1 : 0);

    const practiceOk = practicePoints>=3;
    const finalOk = quizOk && practiceOk;

    $("quizScore").textContent = `${quizScore}/${quizQuestions.length}`;
    $("practiceScore").textContent = practiceOk ? `–∑–∞—Ä–∞—Ö (${practicePoints}/4)` : `–Ω–µ –∑–∞—Ä–∞—Ö (${practicePoints}/4)`;

    if(finalOk){
      const code = genPassCode();
      savedCode = code;
      localStorage.setItem(LS.passCode, code);
      localStorage.setItem(LS.passedAt, nowIso());

      $("finalStatus").textContent = "–ü–†–û–ô–î–ï–ù–û";
      $("finalStatus").className = "status ok";
      $("finalNote").textContent = "–ì–æ—Ç–æ–≤–æ. –°–∫–æ–ø—ñ—é–π –∫–æ–¥ —ñ –ø–µ—Ä–µ—Ö–æ–¥—å –¥–æ –ø–æ–¥–∞—á—ñ.";
      $("passCode").value = code;

      $("copyCodeBtn").disabled = false;
      $("gotoSubmitBtn").disabled = false;

      $("submitCode").value = code;
      $("codeCheckNote").textContent = "–Ñ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –∫–æ–¥. –ù–∞—Ç–∏—Å–Ω–∏ ‚Äú–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–æ–¥‚Äù.";
      showToast("–ü–†–û–ô–î–ï–ù–û. –ö–æ–¥ –∑–±–µ—Ä–µ–∂–µ–Ω–æ.");
    }else{
      $("finalStatus").textContent = "–ù–ï –ü–†–û–ô–î–ï–ù–û";
      $("finalStatus").className = "status bad";
      $("finalNote").textContent = "–î–æ–æ–ø—Ä–∞—Ü—é–π: –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–π –Ω–∞ –≤—Å—ñ 10 –ø–∏—Ç–∞–Ω—å + –∑—Ä–æ–±–∏ –ø—Ä–∞–∫—Ç–∏–∫—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ—à–æ—é.";
      $("passCode").value = "";
      $("copyCodeBtn").disabled = true;
      $("gotoSubmitBtn").disabled = true;
      showToast("–ù–ï –ü–†–û–ô–î–ï–ù–û");
    }
  }

  $("calcBtn").addEventListener("click", calcTraining);
  $("copyCodeBtn").addEventListener("click", ()=>copyText($("passCode").value.trim()));
  $("gotoSubmitBtn").addEventListener("click", ()=>{
    document.querySelector('.tab[data-view="submit"]').click();
  });
  $("resetTrainingBtn").addEventListener("click", ()=>{
    if(confirm("–°–∫–∏–Ω—É—Ç–∏ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è –≤ —Ü—å–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ?")){
      localStorage.removeItem(LS.passCode);
      localStorage.removeItem(LS.passedAt);
      savedCode = null;

      $("passCode").value="";
      $("finalStatus").textContent="‚Äî";
      $("finalStatus").className="status";
      $("copyCodeBtn").disabled=true;
      $("gotoSubmitBtn").disabled=true;

      // lock submit
      $("validateBtn").disabled = true;
      $("sendIdeaBtn").disabled = true;
      $("copyIdeaBtn").disabled = true;
      $("codeCheckNote").textContent = "–°–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ–π–¥–∏ –Ω–∞–≤—á–∞–Ω–Ω—è –∞–±–æ –≤–≤–µ–¥–∏ –≤–∞–ª—ñ–¥–Ω–∏–π –∫–æ–¥.";
      $("codeCheckNote").className = "muted";
      showToast("–°–∫–∏–Ω—É—Ç–æ");
    }
  });

  if(savedCode){
    $("passCode").value = savedCode;
    $("finalStatus").textContent = "–ü–†–û–ô–î–ï–ù–û (–∑–±–µ—Ä–µ–∂–µ–Ω–æ)";
    $("finalStatus").className = "status ok";
    $("finalNote").textContent = "–†–∞–Ω—ñ—à–µ –ø—Ä–æ–π–¥–µ–Ω–æ –≤ —Ü—å–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ. –ú–æ–∂–µ—à –ø–µ—Ä–µ–π—Ç–∏ –¥–æ –ø–æ–¥–∞—á—ñ.";
    $("copyCodeBtn").disabled = false;
    $("gotoSubmitBtn").disabled = false;
    $("submitCode").value = savedCode;
    $("codeCheckNote").textContent = "–Ñ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –∫–æ–¥. –ù–∞—Ç–∏—Å–Ω–∏ ‚Äú–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–æ–¥‚Äù.";
  }

  $("checkCodeBtn").addEventListener("click", ()=>{
    const code = $("submitCode").value.trim();
    const ok = isCodeValid(code);

    $("validateBtn").disabled = !ok;
    $("sendIdeaBtn").disabled = true;
    $("copyIdeaBtn").disabled = true;

    $("codeCheckNote").textContent = ok
      ? "–ö–æ–¥ –≤–∞–ª—ñ–¥–Ω–∏–π ‚úÖ –¢–µ–ø–µ—Ä –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äú–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —ñ–¥–µ—é‚Äù."
      : "–ù–µ–≤—ñ—Ä–Ω–∏–π –∫–æ–¥ –∞–±–æ –∫–æ–¥ –Ω–µ –∑–±—ñ–≥–∞—î—Ç—å—Å—è –∑ –ø—Ä–æ–π–¥–µ–Ω–∏–º —É —Ü—å–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ.";
    $("codeCheckNote").className = ok ? "muted status ok" : "muted status bad";

    showToast(ok ? "–ö–æ–¥ OK" : "–ö–æ–¥ –Ω–µ –ø—Ä–æ–π—à–æ–≤");
  });

  // ---------- Idea validator ----------
  const STRICT_GATE_FOR_SEND = true;
  const MIN_SCORE_OK = 70;

  const ACTION_WORDS = ["–∑–º—ñ–Ω–∏—Ç–∏","–¥–æ–¥–∞—Ç–∏","–ø—Ä–∏–±—Ä–∞—Ç–∏","–≤–∏–¥–∞–ª–∏—Ç–∏","–Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏","–≤–ø—Ä–æ–≤–∞–¥–∏—Ç–∏","—Å—Ç–≤–æ—Ä–∏—Ç–∏","–ø–µ—Ä–µ–π–º–µ–Ω—É–≤–∞—Ç–∏","–æ–Ω–æ–≤–∏—Ç–∏","–∞–≤—Ç–æ–º–∞—Ç–∏–∑—É–≤–∞—Ç–∏","–≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏","–≤–≤–µ—Å—Ç–∏","—Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑—É–≤–∞—Ç–∏","–æ–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏","—É–∑–≥–æ–¥–∏—Ç–∏","–ø–æ–ø—Ä–∞–≤–∏—Ç–∏","–ø–µ—Ä–µ—Ä–æ–±–∏—Ç–∏","—Ä–æ–∑–º—ñ—Å—Ç–∏—Ç–∏","–ø–æ–∑–Ω–∞—á–∏—Ç–∏","–∑–∞–º—ñ–Ω–∏—Ç–∏"];
  const WATER_WORDS = ["—è–∫–æ—Å—å","–ø–æ—Å—Ç—ñ–π–Ω–æ","–≤—ñ—á–Ω–æ","–∑–∞–≤–∂–¥–∏","–Ω—ñ–∫–æ–ª–∏","–ø—Ä–æ—Å—Ç–æ","–≤–∑–∞–≥–∞–ª—ñ","–¥—É–∂–µ","–∂–µ—Å—Ç—å","–ø–æ–≥–∞–Ω–æ","–Ω–µ–∑—Ä—É—á–Ω–æ","—Ç—Ä–µ–±–∞ —â–æ—Å—å","–∑—Ä–æ–±—ñ—Ç—å –∫—Ä–∞—â–µ"];
  const CATEGORY_KEYWORDS = {
    "–ü—Ä–æ—Ü–µ—Å–∏": ["–ø—Ä–æ—Ü–µ—Å","—Ä–µ–≥–ª–∞–º–µ–Ω—Ç","–∞–ª–≥–æ—Ä–∏—Ç–º","—á–µ–∫","—á–µ–∫–ª—ñ—Å—Ç","–∫—Ä–æ–∫","–æ—Ñ–æ—Ä–º–ª–µ–Ω","1—Å","crm","—Ñ–æ—Ä–º–∞","–ø–æ–º–∏–ª–∫","—à–∞–±–ª–æ–Ω","—Å—Ç–∞–Ω–¥–∞—Ä—Ç","—ñ–Ω—Å—Ç—Ä—É–∫—Ü"],
    "–ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è": ["–∫–æ–º—É–Ω—ñ–∫–∞—Ü","–ø–µ—Ä–µ–¥–∞—á","–¥–æ–º–æ–≤","—É–∑–≥–æ–¥","—á–∞—Ç","—Ç–µ–ª–µ—Ñ–æ–Ω","–¥–∑–≤—ñ–Ω","–ø–æ–≤—ñ–¥–æ–º–ª","–≤—ñ–¥–ø–æ–≤—ñ–¥","–∑–≤–æ—Ä–æ—Ç–Ω","—Ñ—ñ–¥–±–µ–∫"],
    "–°–µ—Ä–≤—ñ—Å": ["–∫–ª—ñ—î–Ω—Ç","—Å–µ—Ä–≤—ñ—Å","–≤—ñ–¥–≥—É–∫","—Å–∫–∞—Ä–≥","–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü","–¥–æ—Å—Ç–∞–≤–∫–∞","–∑–±—ñ—Ä–∫","–≥–∞—Ä–∞–Ω—Ç","–ø—ñ—Å–ª—è–ø—Ä–æ–¥–∞–∂","—Å—É–ø—Ä–æ–≤—ñ–¥","–ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è"],
    "–ù–∞–≤—á–∞–Ω–Ω—è": ["–Ω–∞–≤—á–∞–Ω","–∞–¥–∞–ø—Ç–∞—Ü","–∫—É—Ä—Å","—Ç–µ—Å—Ç","—ñ–Ω—Å—Ç—Ä—É–∫—Ç–∞–∂","—Å—Ç–∞–∂—É–≤","–≥—ñ–¥","–∑–Ω–∞–Ω–Ω—è","—Å–∫—Ä–∏–ø—Ç"],
    "–ö—É–ª—å—Ç—É—Ä–∞": ["–∫—É–ª—å—Ç—É—Ä–∞","–∞—Ç–º–æ—Å—Ñ–µ—Ä","–ø–æ–≤–∞–≥–∞","—Ü—ñ–Ω–Ω–æ—Å—Ç","–º–æ—Ç–∏–≤–∞—Ü","–∫–æ–º–∞–Ω–¥–∞","–∫–æ–Ω—Ñ–ª—ñ–∫—Ç","–µ—Ç–∏–∫–∞","–≤–∑–∞—î–º–æ–¥—ñ—è","–ø—ñ–¥—Ç—Ä–∏–º–∫–∞"],
    "–£–º–æ–≤–∏/–±–µ–∑–ø–µ–∫–∞/–∫–æ–º—Ñ–æ—Ä—Ç": ["–±–µ–∑–ø–µ–∫","–∫–æ–º—Ñ–æ—Ä—Ç","—É–º–æ–≤–∏","—Ä–æ–±–æ—á–µ –º—ñ—Å—Ü–µ","—à—É–º","—Å—Ç–∞–Ω—Ü","–∞–∫—É–º","–ø–æ–∂–µ–∂","—ñ–Ω—Å—Ç—Ä—É–∫—Ü –±–µ–∑–ø–µ–∫","–∑–æ–Ω–∞","–ø–æ—Ä—è–¥–æ–∫"]
  };

  function countMatches(text, arr){
    const t = normalize(text); let c=0; arr.forEach(w=>{ if(t.includes(w)) c++; }); return c;
  }
  function hasMetric(text){
    const t = normalize(text);
    return (/\d/.test(t) && (/%|–≥—Ä–Ω|‚Ç¥|—Ö–≤|–≥–æ–¥|–¥–Ω|–¥–µ–Ω—å|—Ä–∞–∑|—à—Ç/.test(t)));
  }
  function guessCategory(allText){
    const t = normalize(allText);
    let best = {cat:"–Ü–Ω—à–µ", score:0};
    Object.keys(CATEGORY_KEYWORDS).forEach(cat=>{
      const score = CATEGORY_KEYWORDS[cat].reduce((acc,kw)=> acc + (t.includes(kw)?1:0), 0);
      if(score > best.score) best = {cat, score};
    });
    return best;
  }

  function validateIdea(){
    const author = ($("i_author").value||"").trim();
    const title = ($("i_title").value||"").trim();
    const problem = ($("i_problem").value||"").trim();
    const solution = ($("i_solution").value||"").trim();
    const effect = ($("i_effect").value||"").trim();
    const proof = ($("i_proof").value||"").trim();
    const cat = $("i_cat").value;
    const dept = ($("i_dept").value||"").trim();

    const allText = `${author}\n${title}\n${problem}\n${solution}\n${effect}\n${proof}\n${dept}\n${cat}`;
    const good = [];
    const fix = [];

    const gate = {
      title: title.length >= 6,
      problem: problem.length >= 25,
      solution: solution.length >= 20,
      effect: effect.length >= 15,
      author: author.length >= 2,
      dept: dept.length >= 2
    };

    let score = 0;

    // Structure 45
    if(gate.author){ score += 5; good.push("–ê–≤—Ç–æ—Ä –≤–∫–∞–∑–∞–Ω–∏–π"); } else fix.push("–í–∫–∞–∂–∏ –∞–≤—Ç–æ—Ä–∞ (–ü–Ü–ë –∞–±–æ –Ω—ñ–∫)");
    if(gate.title){ score += 8; good.push("–ù–∞–∑–≤–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞"); } else fix.push("–ó—Ä–æ–±–∏ –Ω–∞–∑–≤—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ—à–æ—é (–∫—Ä–∞—â–µ –ø–æ—á–∞—Ç–∏ –∑ –¥—ñ—ó)");
    if(gate.problem){ score += 12; good.push("–ü—Ä–æ–±–ª–µ–º–∞ –æ–ø–∏—Å–∞–Ω–∞"); } else fix.push("–û–ø–∏—à–∏ –ø—Ä–æ–±–ª–µ–º—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ—à–µ (–¥–µ/–∫–æ–ª–∏/—â–æ) ‚Äî –º—ñ–Ω. 25 —Å–∏–º–≤–æ–ª—ñ–≤");
    if(gate.solution){ score += 12; good.push("–†—ñ—à–µ–Ω–Ω—è –æ–ø–∏—Å–∞–Ω–µ"); } else fix.push("–û–ø–∏—à–∏ —Ä—ñ—à–µ–Ω–Ω—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ—à–µ ‚Äî –º—ñ–Ω. 20 —Å–∏–º–≤–æ–ª—ñ–≤");
    if(gate.effect){ score += 8; good.push("–ï—Ñ–µ–∫—Ç –≤–∫–∞–∑–∞–Ω–∏–π"); } else fix.push("–î–æ–¥–∞–π –µ—Ñ–µ–∫—Ç ‚Äî –º—ñ–Ω. 15 —Å–∏–º–≤–æ–ª—ñ–≤");

    // Action 15
    const actionCount = countMatches(solution, ACTION_WORDS);
    if(actionCount >= 1){ score += 10; good.push("–Ñ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞ –¥—ñ—è –≤ —Ä—ñ—à–µ–Ω–Ω—ñ"); }
    else fix.push("–ü–æ—á–Ω–∏ —Ä—ñ—à–µ–Ω–Ω—è –∑ –¥—ñ—î—Å–ª–æ–≤–∞: –∑–º—ñ–Ω–∏—Ç–∏/–¥–æ–¥–∞—Ç–∏/–ø—Ä–∏–±—Ä–∞—Ç–∏/–Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏/–≤–ø—Ä–æ–≤–∞–¥–∏—Ç–∏‚Ä¶");
    if(actionCount >= 2){ score += 5; good.push("–†—ñ—à–µ–Ω–Ω—è –¥–µ—Ç–∞–ª—ñ–∑–æ–≤–∞–Ω–µ (–∫—ñ–ª—å–∫–∞ –¥—ñ–π)"); }

    // Metrics 15
    if(hasMetric(effect) || hasMetric(problem)){ score += 15; good.push("–Ñ –≤–∏–º—ñ—Ä—é–≤–∞–Ω—ñ—Å—Ç—å/–º–µ—Ç—Ä–∏–∫–∞"); }
    else fix.push("–î–æ–¥–∞–π –º–µ—Ç—Ä–∏–∫—É: —Ü–∏—Ñ—Ä–∞/—á–∞—Å/%/–≥—Ä–Ω (–Ω–∞ —Å–∫—ñ–ª—å–∫–∏ —Å—Ç–∞–Ω–µ –∫—Ä–∞—â–µ)");

    // Proof 10
    if(normalize(proof).length >= 15){ score += 10; good.push("–Ñ –ø—Ä–∏–∫–ª–∞–¥/–¥–æ–∫–∞–∑"); }
    else fix.push("–î–æ–¥–∞–π –ø—Ä–∏–∫–ª–∞–¥/–æ–ø–∏—Å —Å–∏—Ç—É–∞—Ü—ñ—ó –∞–±–æ —Å–∫—Ä—ñ–Ω—É (–±–∞–∂–∞–Ω–æ)");

    // Dept 5
    if(gate.dept){ score += 5; good.push("–í–∫–∞–∑–∞–Ω–æ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª/–∫–æ–Ω—Ç–µ–∫—Å—Ç"); }
    else fix.push("–í–∫–∞–∂–∏ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª (—Å–∞–ª–æ–Ω/—Å–∫–ª–∞–¥/–æ—Ñ—ñ—Å‚Ä¶)");

    // Water penalty
    const waterCount = countMatches(allText, WATER_WORDS);
    if(waterCount >= 2){ score -= 8; fix.push("–ó–∞–±–∞–≥–∞—Ç–æ '–≤–æ–¥–∏' ‚Äî –∑–∞–º—ñ–Ω–∏ –Ω–∞ —Ñ–∞–∫—Ç–∏/–ø—Ä–∏–∫–ª–∞–¥–∏"); }
    else if(waterCount === 1){ score -= 4; fix.push("–Ñ '–≤–æ–¥–∞' ‚Äî —Å–ø—Ä–æ–±—É–π –∫–æ–Ω–∫—Ä–µ—Ç–∏–∑—É–≤–∞—Ç–∏"); }
    else good.push("–§–æ—Ä–º—É–ª—é–≤–∞–Ω–Ω—è –±–µ–∑ '–≤–æ–¥–∏'");

    // Category match 10
    const guessed = guessCategory(allText);
    if(guessed.score > 0){
      if(guessed.cat === cat){ score += 10; good.push("–ö–∞—Ç–µ–≥–æ—Ä—ñ—è –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Ç–µ–∫—Å—Ç—É"); }
      else { score += 3; fix.push(`–ö–∞—Ç–µ–≥–æ—Ä—ñ—è –º–æ–∂–µ –±—É—Ç–∏ —ñ–Ω—à–æ—é: –∞–ª–≥–æ—Ä–∏—Ç–º –¥—É–º–∞—î "${guessed.cat}"`); }
    }

    score = Math.max(0, Math.min(100, Math.round(score)));

    const mandatoryOk = gate.author && gate.title && gate.problem && gate.solution && gate.effect && gate.dept;
    let statusText = "–ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–ø—Ä–∞—Ü—é–≤–∞—Ç–∏";
    let statusClass = "status bad";
    let reco = "–î–æ–æ–ø—Ä–∞—Ü—é–π –∑–∞ –ø—ñ–¥–∫–∞–∑–∫–∞–º–∏ —ñ –ø–µ—Ä–µ–≤—ñ—Ä —â–µ —Ä–∞–∑";

    if(mandatoryOk && score >= MIN_SCORE_OK){
      statusText = "–ì–æ—Ç–æ–≤–æ –¥–æ –ø–æ–¥–∞—á—ñ";
      statusClass = "status ok";
      reco = "–ú–æ–∂–Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –≤ —Ä–æ–±–æ—Ç—É";
    } else if(mandatoryOk && score >= 55){
      statusText = "–ú–∞–π–∂–µ –≥–æ—Ç–æ–≤–æ";
      statusClass = "status warn";
      reco = "–î–æ–¥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫—É/–º–µ—Ç—Ä–∏–∫—É ‚Äî —ñ –±—É–¥–µ —Å—É–ø–µ—Ä";
    }

    $("v_score").textContent = `${score}/100`;
    $("v_status").textContent = statusText;
    $("v_status").className = statusClass;
    $("v_guess").textContent = guessed.score>0 ? guessed.cat : "‚Äî";
    $("v_reco").textContent = reco;

    setList($("v_good"), good);
    setList($("v_fix"), fix);

    // enable actions
    const canSend = STRICT_GATE_FOR_SEND ? (mandatoryOk && score >= MIN_SCORE_OK) : mandatoryOk;
    $("sendIdeaBtn").disabled = !canSend;
    $("copyIdeaBtn").disabled = !mandatoryOk;

    showToast(`–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: ${score}/100`);
    return {score, mandatoryOk, canSend, guessed: guessed.cat};
  }

  $("validateBtn").addEventListener("click", ()=>{
    if($("validateBtn").disabled){
      alert("–°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äú–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–æ–¥‚Äù.");
      return;
    }
    validateIdea();
  });

  // ---------- Board storage ----------
  function loadIdeas(){
    try{
      const raw = localStorage.getItem(LS.ideas);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function saveIdeas(arr){
    localStorage.setItem(LS.ideas, JSON.stringify(arr || []));
  }
  function newIdeaId(){
    return "idea_" + Math.random().toString(16).slice(2) + "_" + Date.now();
  }

  function buildIdeaTextForCopy(idea){
    return `ID: ${idea.id}
–°–¢–ê–¢–£–°: ${statusLabel(idea.status)}
–°–¢–í–û–†–ï–ù–û: ${fmtDate(idea.createdAt)}
–ö–û–î –ù–ê–í–ß–ê–ù–ù–Ø: ${idea.trainingCode}

–ê–í–¢–û–†: ${idea.author}
–ü–Ü–î–†–û–ó–î–Ü–õ: ${idea.dept}
–ö–ê–¢–ï–ì–û–†–Ü–Ø: ${idea.cat}

–ù–ê–ó–í–ê: ${idea.title}

–ü–†–û–ë–õ–ï–ú–ê:
${idea.problem}

–†–Ü–®–ï–ù–ù–Ø:
${idea.solution}

–ï–§–ï–ö–¢:
${idea.effect}

–î–û–ö–ê–ó–ò / –ü–†–ò–ö–õ–ê–î:
${idea.proof || "‚Äî"}

SCORE: ${idea.score}/100
AI-LITE: ${idea.guessedCat || "‚Äî"}

–í–Ü–î–ü–û–í–Ü–î–ê–õ–¨–ù–ò–ô/–†–Ü–®–ï–ù–ù–Ø: ${idea.owner || "‚Äî"}
–ö–û–ú–ï–ù–¢–ê–†: ${idea.comment || "‚Äî"}`;
  }

  // send idea (to board)
  $("sendIdeaBtn").addEventListener("click", ()=>{
    const code = ($("submitCode").value||"").trim();
    if(!isCodeValid(code)){
      alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –∫–æ–¥. –ù–∞—Ç–∏—Å–Ω–∏ ‚Äú–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–æ–¥‚Äù.");
      return;
    }

    const v = validateIdea();
    if(STRICT_GATE_FOR_SEND && !v.canSend){
      alert("–Ü–¥–µ—è –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –ø–µ—Ä–µ–≤—ñ—Ä–∫—É (–º—ñ–Ω. 70/100 + –æ–±–æ–≤ º—è–∑–∫–æ–≤—ñ –ø–æ–ª—è).");
      return;
    }

    const idea = {
      id: newIdeaId(),
      createdAt: nowIso(),
      updatedAt: nowIso(),
      trainingCode: code,
      status: "new",
      author: ($("i_author").value||"").trim(),
      dept: ($("i_dept").value||"").trim(),
      cat: $("i_cat").value,
      title: ($("i_title").value||"").trim(),
      problem: ($("i_problem").value||"").trim(),
      solution: ($("i_solution").value||"").trim(),
      effect: ($("i_effect").value||"").trim(),
      proof: ($("i_proof").value||"").trim(),
      score: parseInt(($("v_score").textContent||"0").split("/")[0], 10) || 0,
      guessedCat: $("v_guess").textContent || "",
      owner: "",
      comment: "",
      history: [`${fmtDate(nowIso())} ‚Äî –°—Ç–≤–æ—Ä–µ–Ω–æ (—Å—Ç–∞—Ç—É—Å: –ù–æ–≤—ñ)`]
    };

    const ideas = loadIdeas();
    ideas.unshift(idea);
    saveIdeas(ideas);

    showToast("–Ü–¥–µ—é –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ");
    // go to board
    document.querySelector('.tab[data-view="board"]').click();
  });

  $("copyIdeaBtn").addEventListener("click", async ()=>{
    const code = ($("submitCode").value||"").trim();
    const idea = {
      id:"‚Äî",
      createdAt: nowIso(),
      trainingCode: code,
      status:"new",
      author: ($("i_author").value||"").trim() || "‚Äî",
      dept: ($("i_dept").value||"").trim() || "‚Äî",
      cat: $("i_cat").value,
      title: ($("i_title").value||"").trim(),
      problem: ($("i_problem").value||"").trim(),
      solution: ($("i_solution").value||"").trim(),
      effect: ($("i_effect").value||"").trim(),
      proof: ($("i_proof").value||"").trim(),
      score: parseInt(($("v_score").textContent||"0").split("/")[0], 10) || 0,
      guessedCat: $("v_guess").textContent || "‚Äî",
      owner:"",
      comment:""
    };
    await copyText(buildIdeaTextForCopy(idea));
  });

  $("clearIdeaBtn").addEventListener("click", ()=>{
    ["i_author","i_title","i_problem","i_solution","i_effect","i_proof","i_dept"].forEach(id=>$(id).value="");
    $("sendIdeaBtn").disabled = true;
    $("copyIdeaBtn").disabled = true;
    $("v_score").textContent="‚Äî";
    $("v_status").textContent="‚Äî";
    $("v_status").className="v";
    $("v_guess").textContent="‚Äî";
    $("v_reco").textContent="‚Äî";
    setList($("v_good"), []);
    setList($("v_fix"), []);
    showToast("–û—á–∏—â–µ–Ω–æ");
  });

  // enable validate only after code check ok
  $("validateBtn").disabled = true;
  $("sendIdeaBtn").disabled = true;
  $("copyIdeaBtn").disabled = true;

  // if saved code exists, prefill
  if(savedCode){
    $("submitCode").value = savedCode;
    $("codeCheckNote").textContent = "–Ñ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π –∫–æ–¥. –ù–∞—Ç–∏—Å–Ω–∏ ‚Äú–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–æ–¥‚Äù.";
  }

  // ---------- Board ----------
  const STATUSES = [
    {key:"new", label:"–ù–æ–≤—ñ"},
    {key:"review", label:"–ù–∞ —Ä–æ–∑–≥–ª—è–¥—ñ"},
    {key:"backlog", label:"Backlog"},
    {key:"test", label:"–¢–µ—Å—Ç"},
    {key:"done", label:"–í–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–æ"},
    {key:"rejected", label:"–í—ñ–¥—Ö–∏–ª–µ–Ω–æ"},
  ];
  const statusLabel = (k)=> (STATUSES.find(x=>x.key===k)?.label) || k;

  function matchesFilters(idea){
    const q = normalize($("searchBox")?.value || "");
    const cat = $("filterCat")?.value || "";
    const hay = normalize(`${idea.title} ${idea.author} ${idea.dept} ${idea.cat} ${idea.problem} ${idea.solution}`);
    const okQ = !q || hay.includes(q);
    const okC = !cat || idea.cat === cat;
    return okQ && okC;
  }

  function renderBoard(){
    const host = $("boardCols");
    if(!host) return;

    const ideas = loadIdeas().filter(matchesFilters);

    host.innerHTML = "";
    STATUSES.forEach(s=>{
      const col = document.createElement("div");
      col.className = "col";
      const items = ideas.filter(i=>i.status===s.key);
      col.innerHTML = `<h4><span>${s.label}</span><span class="colCount">${items.length}</span></h4><div class="colBody"></div>`;
      const body = col.querySelector(".colBody");

      items.forEach(it=>{
        const card = document.createElement("div");
        card.className = "ideaCard";
        card.dataset.id = it.id;
        card.innerHTML = `
          <div class="ideaTitle">${escapeHtml(it.title || "‚Äî")}</div>
          <div class="ideaMeta">
            <span class="tag">Score: ${it.score || 0}</span>
            <span class="tag">${escapeHtml(it.cat || "‚Äî")}</span>
            <span class="tag">${escapeHtml(it.author || "‚Äî")}</span>
          </div>
          <div class="ideaMeta" style="margin-top:6px">
            <span class="tag">${escapeHtml(it.dept || "‚Äî")}</span>
            <span class="tag">${escapeHtml(fmtDate(it.createdAt))}</span>
          </div>
        `;
        card.addEventListener("click", ()=>openModal(it.id));
        body.appendChild(card);
      });

      host.appendChild(col);
    });
  }

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  $("searchBox")?.addEventListener("input", renderBoard);
  $("filterCat")?.addEventListener("change", renderBoard);

  // Export JSON
  $("exportJsonBtn")?.addEventListener("click", async ()=>{
    const ideas = loadIdeas();
    const blob = new Blob([JSON.stringify(ideas, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    download(url, `ideas_export_${Date.now()}.json`);
    showToast("–ï–∫—Å–ø–æ—Ä—Ç JSON");
  });

  // Export CSV (simple)
  $("exportCsvBtn")?.addEventListener("click", ()=>{
    const ideas = loadIdeas();
    const cols = ["id","status","createdAt","updatedAt","score","cat","guessedCat","author","dept","title","problem","solution","effect","proof","owner","comment","trainingCode"];
    const esc = (v)=> `"${String(v ?? "").replace(/"/g,'""')}"`;
    const lines = [
      cols.join(","),
      ...ideas.map(i=>cols.map(c=>esc(i[c])).join(","))
    ];
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    download(url, `ideas_export_${Date.now()}.csv`);
    showToast("–ï–∫—Å–ø–æ—Ä—Ç CSV");
  });

  $("clearAllBtn")?.addEventListener("click", ()=>{
    if(confirm("–¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ —ñ–¥–µ—ó –Ω–∞ –¥–æ—à—Ü—ñ? (–ª–∏—à–µ –≤ —Ü—å–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ)")){
      localStorage.removeItem(LS.ideas);
      renderBoard();
      showToast("–û—á–∏—â–µ–Ω–æ");
    }
  });

  function download(url, filename){
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  // ---------- Modal ----------
  let activeId = null;

  function openModal(id){
    const ideas = loadIdeas();
    const it = ideas.find(x=>x.id===id);
    if(!it) return;

    activeId = id;
    $("modalBg").classList.add("show");
    $("modalBg").setAttribute("aria-hidden","false");

    $("m_title").textContent = it.title || "‚Äî";
    $("m_meta").innerHTML = `
      <span class="tag">${escapeHtml(statusLabel(it.status))}</span>
      <span class="tag">Score: ${it.score || 0}</span>
      <span class="tag">${escapeHtml(it.cat || "‚Äî")}</span>
      <span class="tag">${escapeHtml(it.author || "‚Äî")}</span>
      <span class="tag">${escapeHtml(it.dept || "‚Äî")}</span>
      <span class="tag">${escapeHtml(fmtDate(it.createdAt))}</span>
    `;

    $("m_problem").textContent = it.problem || "‚Äî";
    $("m_solution").textContent = it.solution || "‚Äî";
    $("m_effect").textContent = it.effect || "‚Äî";
    $("m_proof").textContent = it.proof || "‚Äî";

    $("m_status").value = it.status;
    $("m_owner").value = it.owner || "";
    $("m_comment").value = it.comment || "";

    $("m_history").textContent = (it.history || []).join("\n");
  }

  function closeModal(){
    activeId = null;
    $("modalBg").classList.remove("show");
    $("modalBg").setAttribute("aria-hidden","true");
  }
  $("modalCloseBtn").addEventListener("click", closeModal);
  $("modalBg").addEventListener("click", (e)=>{ if(e.target.id==="modalBg") closeModal(); });

  $("m_saveBtn").addEventListener("click", ()=>{
    if(!activeId) return;
    const ideas = loadIdeas();
    const idx = ideas.findIndex(x=>x.id===activeId);
    if(idx<0) return;

    const before = ideas[idx];
    const newStatus = $("m_status").value;
    const owner = ($("m_owner").value||"").trim();
    const comment = ($("m_comment").value||"").trim();

    const hist = Array.isArray(before.history) ? before.history.slice() : [];
    const changes = [];
    if(before.status !== newStatus) changes.push(`—Å—Ç–∞—Ç—É—Å: ${statusLabel(before.status)} ‚Üí ${statusLabel(newStatus)}`);
    if((before.owner||"") !== owner) changes.push(`–≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π/—Ä—ñ—à–µ–Ω–Ω—è: "${before.owner||"‚Äî"}" ‚Üí "${owner||"‚Äî"}"`);
    if((before.comment||"") !== comment) changes.push(`–∫–æ–º–µ–Ω—Ç–∞—Ä –æ–Ω–æ–≤–ª–µ–Ω–æ`);

    if(changes.length){
      hist.push(`${fmtDate(nowIso())} ‚Äî ${changes.join(", ")}`);
    }

    ideas[idx] = {
      ...before,
      status: newStatus,
      owner,
      comment,
      history: hist,
      updatedAt: nowIso()
    };
    saveIdeas(ideas);

    showToast("–ó–±–µ—Ä–µ–∂–µ–Ω–æ");
    // refresh modal view + board
    openModal(activeId);
    renderBoard();
  });

  $("m_deleteBtn").addEventListener("click", ()=>{
    if(!activeId) return;
    if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —ñ–¥–µ—é?")) return;
    const ideas = loadIdeas().filter(x=>x.id!==activeId);
    saveIdeas(ideas);
    closeModal();
    renderBoard();
    showToast("–í–∏–¥–∞–ª–µ–Ω–æ");
  });

});
</script>
</body>
</html>
